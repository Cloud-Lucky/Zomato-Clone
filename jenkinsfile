pipeline{
    agent any
    tools {
        jdk 'JDK-17'
        nodejs 'node 16'
    }
    environment {
        SCANNER_HOME=tool 'sonar-scanner'
    }
    stages{
        stage('clean-workspace'){
            steps{
                cleanWs()
            }
        }
        stage('Git-clone'){
            steps{
                git branch: 'main', url: 'https://github.com/vijaygiduthuri/Zomato.git'
            }
        }
        stage('SonarQube-Analysis'){
            steps{
                withSonarQubeEnv('sonar-server'){
                    sh "${SCANNER_HOME}/bin/sonar-scanner -Dsonar.projectName=Zomato -Dsonar.projectKey=Zomato"
                }
            }
        }
        stage('Quality-Gate'){
            steps{
                timeout(time: 1, unit: 'HOURS') {
                    waitForQualityGate abortPipeline: false, credentialsId: 'Sonar-token'
                }
            }
        }
        stage('install-dependencies'){
            steps{
                sh 'npm install'
            }
        }
        stage('owasp-dependency-check'){
            steps{
                dependencyCheck additionalArguments: '--scan ./ --disableYarnAudit --disableNodeAudit', odcInstallation: 'DP-Check'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }
        stage('trivy-fs-scan'){
            steps{
                sh 'trivy fs . > trivyfs-report.txt'
            }
            
        }
        stage('docker-build'){
           steps{
             withCredentials([usernamePassword(credentialsId: 'Docker_Cred', passwordVariable: 'DockerHubPassword', usernameVariable: 'DockerHubUser')]) {
                sh '''
                   echo "$DockerHubPassword" | docker login -u "$DockerHubUser" --password-stdin
                   docker build -t zomato .
                   docker tag zomato laxmireddy870113/zomato:latest
                   docker push laxmireddy870113/zomato:latest
                 '''
                }
            }
        }
        stage('trivy-docker-scan'){
            steps{
                sh 'trivy image laxmireddy870113/zomato:latest > trivy-docker.json'
            }
        }
        stage('docker-run'){
            steps{
                sh 'docker run -d -p 3000:3000 laxmireddy870113/zomato:latest'
            }
        }
        stage('deploy-kubernetes'){
            steps{
                sh 'kubectl apply -f deployment.yaml'
            }
        }
        stage('service-kubernetes'){
            steps{
                sh 'kubectl apply -f service.yaml'
            }
        }
    }
}